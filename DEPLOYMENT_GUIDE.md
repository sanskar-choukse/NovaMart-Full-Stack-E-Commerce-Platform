# Deployment Guide for Render

## ‚úÖ Changes Made

### 1. Cloudinary Integration (Media Storage)
- Added `django-cloudinary-storage` and `cloudinary` to requirements.txt
- Configured Cloudinary in settings to handle product images
- Images will now be stored in Cloudinary instead of local filesystem

### 2. Automatic Data Loading
- Modified `build.sh` to automatically load products on first deployment
- Only loads data if database is empty (prevents duplicates)

### 3. Database Connection
- Already configured for PostgreSQL via `DATABASE_URL`
- Your database URL: `postgresql://novamart:***@dpg-d6en3o41hm7c73f9gh8g-a/novamart`

---

## üîß Setup Instructions

### Step 1: Get Cloudinary Credentials

1. Go to: https://cloudinary.com/users/register/free
2. Sign up for a free account
3. After login, go to Dashboard: https://console.cloudinary.com/
4. You'll see three values:
   - **Cloud Name** (e.g., `dxyz123abc`)
   - **API Key** (e.g., `123456789012345`)
   - **API Secret** (e.g., `abcdefghijklmnopqrstuvwxyz`)

### Step 2: Add Environment Variables to Render

Go to your Render dashboard ‚Üí Your service ‚Üí Environment

Add these three new variables:

```
CLOUDINARY_CLOUD_NAME=your_cloud_name_here
CLOUDINARY_API_KEY=your_api_key_here
CLOUDINARY_API_SECRET=your_api_secret_here
```

### Step 3: Verify Existing Variables

Make sure these are already set (they should be):

```
DATABASE_URL=postgresql://novamart:wZAm3HiyUd0L0ZOncG0x02Kv7EzwbOe6@dpg-d6en3o41hm7c73f9gh8g-a/novamart
DJANGO_SETTINGS_MODULE=config.settings.prod
DEBUG=False
SECRET_KEY=(auto-generated by Render)
ALLOWED_HOSTS=your-app.onrender.com
RAZORPAY_KEY_ID=rzp_test_***
RAZORPAY_KEY_SECRET=***
```

### Step 4: Deploy

1. Commit and push your changes:
   ```bash
   git add .
   git commit -m "Add Cloudinary integration and auto data loading"
   git push
   ```

2. Render will automatically:
   - Install dependencies (including Cloudinary)
   - Run migrations
   - Load products from DummyJSON API (if database is empty)
   - Start the application

---

## üß™ Testing Database Connection

### On Render (via Shell)

1. Go to Render Dashboard ‚Üí Your service ‚Üí Shell
2. Run:
   ```bash
   python test_db_connection.py
   ```

This will verify:
- PostgreSQL connection
- Migrations status
- Product count
- Environment variables

### Manual Data Loading (if needed)

If products don't load automatically:

```bash
python load_data_render.py
```

Or directly:

```bash
python manage.py load_dummyjson_products
```

---

## üìã What Happens on Deployment

1. **Install packages** ‚Üí Includes Cloudinary libraries
2. **Collect static files** ‚Üí CSS, JS, images
3. **Run migrations** ‚Üí Create/update database tables
4. **Check product count** ‚Üí If 0, load data automatically
5. **Load products** ‚Üí Downloads 100+ products from DummyJSON API
6. **Upload images** ‚Üí Images go to Cloudinary (not local storage)
7. **Start server** ‚Üí Application is live

---

## üîç Troubleshooting

### Products not showing?

```bash
# Check product count
python manage.py shell -c "from apps.products.models import Product; print(Product.objects.count())"

# Load manually if needed
python manage.py load_dummyjson_products
```

### Database connection issues?

```bash
python test_db_connection.py
```

### Images not loading?

1. Verify Cloudinary credentials in Render environment
2. Check logs for upload errors
3. Ensure `CLOUDINARY_CLOUD_NAME` is set correctly

### Build fails?

Check Render logs for:
- Missing environment variables
- Database connection errors
- Package installation issues

---

## üìù Local Development

Your local `.env` now includes Cloudinary variables (optional for local dev):

```env
CLOUDINARY_CLOUD_NAME=
CLOUDINARY_API_KEY=
CLOUDINARY_API_SECRET=
```

If empty, Django will use local filesystem storage (development mode).
If filled, Django will use Cloudinary (production-like mode).

---

## üéØ Summary

**What was fixed:**
1. ‚úÖ Cloudinary integration for persistent media storage
2. ‚úÖ Automatic data loading in build.sh
3. ‚úÖ Database connection test script
4. ‚úÖ Manual data loading script (backup)
5. ‚úÖ Updated environment configuration

**What you need to do:**
1. Get Cloudinary credentials (free account)
2. Add 3 environment variables to Render
3. Push code to trigger deployment
4. Verify products load successfully

**Nothing was broken:**
- Local development still works with SQLite
- Existing code remains functional
- Database configuration unchanged
- All existing features preserved
